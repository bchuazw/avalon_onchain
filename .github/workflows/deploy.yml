name: Build and Deploy to Devnet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-action@stable
    
    - name: Install Solana CLI
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.18.17/install)"
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        solana --version
    
    - name: Install Anchor
      run: |
        cargo install --git https://github.com/coral-xyz/anchor --tag v0.30.1 anchor-cli --locked
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        anchor --version
    
    - name: Setup Solana Keypair
      run: |
        mkdir -p ~/.config/solana
        echo '[198,55,98,150,73,164,51,132,90,18,171,193,116,46,163,143,223,198,202,252,204,185,33,185,200,206,100,207,175,152,24,209,128,185,255,31,153,253,87,241,132,193,252,127,167,218,252,63,98,76,227,45,219,255,136,59,6,187,124,225,237,192,106,108]' > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
    
    - name: Configure Solana for Devnet
      run: |
        solana config set --url devnet
        solana address
    
    - name: Airdrop SOL
      run: |
        solana airdrop 2 || solana airdrop 1 || solana airdrop 0.5 || true
    
    - name: Build Anchor Program
      run: |
        anchor build
    
    - name: Deploy to Devnet
      id: deploy
      run: |
        DEPLOY_OUTPUT=$(anchor deploy 2>&1)
        echo "$DEPLOY_OUTPUT"
        echo "---"
        PROGRAM_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP 'Program Id: \K[\w]+' || echo "")
        if [ -n "$PROGRAM_ID" ]; then
          echo "program_id=$PROGRAM_ID" >> $GITHUB_OUTPUT
          echo "Deployed successfully! Program ID: $PROGRAM_ID"
        else
          echo "Could not extract Program ID from output"
          echo "Full output above"
        fi
    
    - name: Update Anchor.toml with Program ID
      if: steps.deploy.outputs.program_id != ''
      run: |
        sed -i "s/avalon_game = \"[^\"]*\"/avalon_game = \"${{ steps.deploy.outputs.program_id }}\"/" Anchor.toml
    
    - name: Commit and Push Program ID
      if: steps.deploy.outputs.program_id != ''
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add Anchor.toml
        git diff --cached --quiet || git commit -m "Update program ID from devnet deployment: ${{ steps.deploy.outputs.program_id }}"
        git push || true

  test:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install Dependencies
      run: |
        yarn install --frozen-lockfile || yarn install
        cd backend && yarn install
        cd ../tests/e2e && yarn install
    
    - name: Run Logic Verification
      run: |
        node verify.js
