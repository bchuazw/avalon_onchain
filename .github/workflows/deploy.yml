name: Build and Deploy to Devnet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Install Solana CLI
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.18.17/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
    
    - name: Install Anchor
      run: |
        cargo install --git https://github.com/coral-xyz/anchor --tag v0.30.1 anchor-cli
    
    - name: Setup Solana Keypair
      run: |
        mkdir -p ~/.config/solana
        # Create keypair from the saved bytes
        echo '[198,55,98,150,73,164,51,132,90,18,171,193,116,46,163,143,223,198,202,252,204,185,33,185,200,206,100,207,175,152,24,209,128,185,255,31,153,253,87,241,132,193,252,127,167,218,252,63,98,76,227,45,219,255,136,59,6,187,124,225,237,192,106,108]' > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
    
    - name: Configure Solana for Devnet
      run: |
        solana config set --url devnet
        solana airdrop 2 || solana airdrop 1 || solana airdrop 0.5 || true
    
    - name: Build Anchor Program
      run: |
        anchor build
    
    - name: Deploy to Devnet
      id: deploy
      run: |
        DEPLOY_OUTPUT=$(anchor deploy 2>&1)
        echo "$DEPLOY_OUTPUT"
        PROGRAM_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP 'Program Id: \K[\w]+' || echo "")
        if [ -n "$PROGRAM_ID" ]; then
          echo "program_id=$PROGRAM_ID" >> $GITHUB_OUTPUT
          echo "Deployed successfully! Program ID: $PROGRAM_ID"
        else
          echo "Deployment may have failed or output format unexpected"
          echo "Full output: $DEPLOY_OUTPUT"
          exit 1
        fi
    
    - name: Update Anchor.toml with Program ID
      if: success()
      run: |
        PROGRAM_ID="${{ steps.deploy.outputs.program_id }}"
        if [ -n "$PROGRAM_ID" ]; then
          sed -i "s/avalon_game = \"[^\"]*\"/avalon_game = \"$PROGRAM_ID\"/" Anchor.toml
          echo "Updated Anchor.toml with Program ID: $PROGRAM_ID"
        fi
    
    - name: Commit and Push Program ID
      if: success()
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add Anchor.toml
        git diff --cached --quiet || git commit -m "Update program ID from devnet deployment: ${{ steps.deploy.outputs.program_id }}"
        git push
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          target/deploy/*.so
          target/idl/*.json
          target/types/*.ts

  test:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Dependencies
      run: |
        yarn install
        cd backend && yarn install
        cd ../tests/e2e && yarn install
    
    - name: Run Logic Verification
      run: |
        node verify.js
    
    - name: Run Tests
      run: |
        anchor test --skip-local-validator || true
